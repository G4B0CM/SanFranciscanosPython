{% extends 'base.html' %}
{% from "_form_helpers.html" import render_field %}
{% block title %}{{ title }}{% endblock %}

{% block head_extra %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<style>
    .select2-container .select2-selection--multiple {
        min-height: 150px;
        /* Hacer el campo de selección más alto */
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-user-plus me-2"></i>{{ title }}</h4>
                </div>
                <div class="card-body">
                    <p class="card-text">Seleccione un curso y luego los catequizados que desea inscribir. El sistema
                        validará los prerrequisitos para cada uno.</p>
                    <form id="enrollment-form" method="POST" action="{{ url_for('Enrollments.enroll') }}">
                        {{ form.hidden_tag() }}
                        <div class="mb-3">
                            {{ render_field(form.idCurso, class="form-select") }}
                        </div>
                        <div class="mb-3">
                            {{ render_field(form.catequizados, class="form-control") }}
                        </div>
                        <div class="text-center">
                            {{ form.submit(class="btn btn-primary btn-lg") }}
                            <a href="{{ url_for('Enrollments.list_enrollments') }}"
                                class="btn btn-secondary btn-lg ms-2">Ver Inscritos</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para mostrar resultados -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultModalLabel">Resultados de la Inscripción</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="modal-success-summary" class="alert alert-success d-none"></div>
                <div id="modal-error-summary" class="alert alert-danger d-none">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Se encontraron los siguientes errores:</h6>
                    <ul id="modal-error-list" class="mb-0"></ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function () {
        // Aplicar Select2 a los dropdowns para una mejor UX
        $('#idCurso').select2({ theme: "bootstrap-5" });
        $('#catequizados').select2({ theme: "bootstrap-5" });

        // Interceptar el envío del formulario con AJAX
        $('#enrollment-form').on('submit', function (e) {
            e.preventDefault(); // Evitar el envío normal del formulario

            var formData = $(this).serialize(); // Recolectar datos del formulario
            var submitButton = $(this).find('input[type="submit"]');
            submitButton.prop('disabled', true).val('Procesando...');

            $.ajax({
                type: 'POST',
                url: $(this).attr('action'),
                data: formData,
                success: function (response) {
                    // Limpiar el contenido anterior del modal
                    $('#modal-success-summary').addClass('d-none').text('');
                    $('#modal-error-summary').addClass('d-none');
                    $('#modal-error-list').empty();

                    // Mostrar resumen de éxito
                    if (response.success_count > 0) {
                        $('#modal-success-summary').text(response.success_count + ' catequizado(s) inscrito(s) exitosamente.').removeClass('d-none');
                    }

                    // Mostrar errores
                    if (response.error_messages.length > 0) {
                        response.error_messages.forEach(function (msg) {
                            $('#modal-error-list').append('<li>' + msg + '</li>');
                        });
                        $('#modal-error-summary').removeClass('d-none');
                    }

                    // Si no hay éxito ni errores (caso raro), mostrar mensaje genérico
                    if (response.success_count === 0 && response.error_messages.length === 0) {
                        $('#modal-success-summary').text('No se procesó ninguna inscripción. Verifique las selecciones.').removeClass('d-none');
                    }

                    // Mostrar el modal
                    var resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
                    resultModal.show();
                },
                error: function () {
                    alert('Ocurrió un error inesperado en el servidor. Por favor, intente de nuevo.');
                },
                complete: function () {
                    submitButton.prop('disabled', false).val('Inscribir Seleccionados');
                }
            });
        });
    });
</script>
{% endblock %}